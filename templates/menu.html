{% extends 'base.html' %}

{% block content %}
<div class="menu-page">
    <header class="menu-header">
        <h1>Our <span class="highlight">Menu</span></h1>
        <p>Choose from our delectable selection of dishes.</p>
    </header>

    <!-- Menu Category Bar -->
    <div class="menu-category-bar">
        <div class="category-item active" data-category="all">All Items</div>
        <div class="category-item" data-category="breakfast">Breakfast</div>
        <div class="category-item" data-category="lunch">Lunch</div>
        <div class="category-item" data-category="snacks">Snacks</div>
        <div class="category-item" data-category="dinner">Dinner</div>
        <div class="category-item" data-category="beverages">Beverages</div>
    </div>

    <div class="menu-grid" id="menu-grid">
        {% for item in menu %}
        <div class="menu-card" data-id="{{ item.id }}">
            <div class="card-image">
                <img src="{{ url_for('static', filename='images/' + item.image) }}" alt="{{ item.name }}"
                    loading="lazy">
                {% if item.veg == true %}
                <div class="veg-indicator"></div>
                {% else %}
                <div class="non-veg-indicator"></div>
                {% endif %}
            </div>
            <div class="card-info">
                <span class="category-tag">{{ item.category }}</span>
                <h3>{{ item.name }}</h3>
                <p class="description">{{ item.description }}</p>
                <div class="card-footer">
                    <span class="price">₹{{ item.price }}</span>
                    <button class="add-btn" data-id="{{ item.id }}" data-name="{{ item.name|tojson|replace('"', '&quot;') }}" data-price="{{ item.price }}" onclick="handleAddToCart(this)">
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Function to get URL parameters
function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// Menu Category Filtering for menu page
if (document.querySelector('.category-item')) {
    const categoryItems = document.querySelectorAll('.category-item');
    
    // Check if a category is specified in the URL when the page loads
    const initialCategory = getUrlParameter('category');
    if (initialCategory) {
        // Remove active class from all items
        categoryItems.forEach(cat => cat.classList.remove('active'));
        
        // Find the corresponding category item and activate it
        const targetCategoryItem = Array.from(categoryItems).find(item => 
            item.getAttribute('data-category') === initialCategory
        );
        
        if (targetCategoryItem) {
            targetCategoryItem.classList.add('active');
            
            // Load the filtered menu items for the initial category
            const menuGrid = document.getElementById('menu-grid');
            if (menuGrid) {
                menuGrid.innerHTML = '<div class="loading-message">Loading menu items...</div>';
                
                fetch(`/menu/filter/${initialCategory}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayFilteredMenuItems(data.items, menuGrid);
                    } else {
                        menuGrid.innerHTML = '<div class="error-message">Failed to load menu items</div>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching menu items:', error);
                    menuGrid.innerHTML = '<div class="error-message">Error loading menu items</div>';
                });
            }
        }
    }
    
    categoryItems.forEach(item => {
        item.addEventListener('click', function() {
            // Remove active class from all items
            categoryItems.forEach(cat => cat.classList.remove('active'));
            
            // Add active class to clicked item
            this.classList.add('active');
            
            // Get selected category
            const selectedCategory = this.getAttribute('data-category');
            
            // Show loading indicator
            const menuGrid = document.getElementById('menu-grid');
            if (menuGrid) {
                menuGrid.innerHTML = '<div class="loading-message">Loading menu items...</div>';
                
                // Make AJAX request to backend to get filtered menu items
                fetch(`/menu/filter/${selectedCategory}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayFilteredMenuItems(data.items, menuGrid);
                    } else {
                        menuGrid.innerHTML = '<div class="error-message">Failed to load menu items</div>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching menu items:', error);
                    menuGrid.innerHTML = '<div class="error-message">Error loading menu items</div>';
                });
            }
        });
    });
}

function displayFilteredMenuItems(items, menuGrid) {
    if (!items || items.length === 0) {
        menuGrid.innerHTML = '<div class="no-items-message">No items found in this category</div>';
        return;
    }
    
    let menuHTML = '';
    items.forEach(item => {
        // Create the HTML string using proper string concatenation
        menuHTML += '<div class="menu-card" data-id="' + item.id + '">' +
                   '<div class="card-image">' +
                   '<img src="/static/images/' + item.image + '" alt="' + item.name + '" loading="lazy">' +
                   '</div>' +
                   '<div class="card-info">' +
                   '<span class="category-tag">' + item.category + '</span>' +
                   '<h3>' + item.name + '</h3>' +
                   '<p class="description">' + item.description + '</p>' +
                   '<div class="card-footer">' +
                   '<span class="price">₹' + item.price + '</span>' +
                   '<button class="add-btn" data-id="' + item.id + '" data-name="' + encodeURIComponent(item.name) + '" data-price="' + item.price + '" onclick="handleAddToCart(this)">' +
                   'Add to Cart' +
                   '</button>' +
                   '</div>' +
                   '</div>' +
                   '</div>';
    });
    
    menuGrid.innerHTML = menuHTML;
}

function handleAddToCart(buttonElement) {
    const id = buttonElement.getAttribute('data-id');
    const name = decodeURIComponent(buttonElement.getAttribute('data-name'));
    const price = parseFloat(buttonElement.getAttribute('data-price'));
    
    // Use the addToCart function from script.js
    addToCart(id, name, price);
}
</script>
{% endblock %}